{% extends "base.html" %}

{% block title %}Онлайн-компилятор Python{% endblock %}

{% block content %}
<section class="compiler-header">
    <h2>Онлайн-компилятор Python</h2>
    <button id="run-python" class="btn">▶ Запустить код</button>
</section>

<p class="compiler-description">
    Учебный режим: слева код квиза, справа консоль. Шаблон ниже — обычное консольное приложение на Python.
</p>

<section class="compiler-layout">
    <div class="editor-panel">
        <h3>Редактор кода</h3>
        <textarea id="python-editor" spellcheck="false">def run_quiz():
    print("=== Мини-квиз по Python ===")

    name = input("Как тебя зовут? ")
    score = 0

    answer_1 = input("1) Что возвращает len('cat')? ")
    if answer_1.strip() == "3":
        score += 1

    answer_2 = input("2) Какой тип у {1, 2, 3}? (set/list/dict) ")
    if answer_2.strip().lower() == "set":
        score += 1

    print(f"\\n{name}, твой результат: {score}/2")


run_quiz()</textarea>
    </div>

    <div class="console-panel">
        <h3>Консоль</h3>
        <pre id="python-console">Нажмите «Запустить код», чтобы выполнить шаблон квиза.</pre>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>
<script>
    const runButton = document.getElementById('run-python');
    const editor = document.getElementById('python-editor');
    const output = document.getElementById('python-console');

    function appendOutput(text) {
        output.textContent += text;
    }

    function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles['files'][x] === undefined) {
            throw new Error("Файл не найден: '" + x + "'");
        }
        return Sk.builtinFiles['files'][x];
    }

    runButton.addEventListener('click', async () => {
        output.textContent = '';

        Sk.pre = 'python-console';
        Sk.configure({
            output: appendOutput,
            read: builtinRead,
            inputfunTakesPrompt: true,
            inputfun: (promptText) => {
                const userInput = window.prompt(promptText) ?? '';
                appendOutput(promptText + userInput + '\n');
                return Promise.resolve(userInput);
            }
        });

        try {
            await Sk.misceval.asyncToPromise(() => Sk.importMainWithBody('<stdin>', false, editor.value, true));
        } catch (error) {
            appendOutput('\n[Ошибка] ' + error.toString());
        }
    });
</script>
{% endblock %}
